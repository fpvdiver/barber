<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perfil — Mineiro Barbershop</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">

  <style>
    .wrap{max-width:428px;margin:0 auto;padding:14px 14px 96px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    .panel h2{margin:0 0 10px;font:600 14px/1 Poppins;letter-spacing:.02em}
    .muted{color:var(--muted)}
    .ph{display:flex;align-items:center;gap:14px;margin-bottom:6px}
    .avatar{width:72px;height:72px;border-radius:16px;background:#0f1012;border:1px solid var(--line);
      display:grid;place-items:center;font:700 24px/1 Poppins;color:#e9eaef;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .edit-photo{border:1px dashed var(--line);background:#141519;color:#e6e7ea;padding:8px 10px;border-radius:10px;font:600 12px/1 Poppins;cursor:pointer}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:380px){.grid-2{grid-template-columns:1fr}}
    .field{margin:0 0 10px}
    .label{display:block;margin:0 0 6px;font:600 12px/1 Poppins;letter-spacing:.14em;text-transform:uppercase;color:#d9dade}
    .input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#111214;color:var(--text);font:15px/1.4 Poppins;outline:0;transition:border-color .2s,box-shadow .2s}
    .input:focus{border-color:rgba(211,168,91,.55);box-shadow:0 0 0 3px rgba(211,168,91,.14)}
    .switch{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid var(--line)}
    .switch:first-of-type{border-top:0}
    .switch label{font:500 14px/1.2 Poppins}
    .switch input{accent-color:var(--gold);width:22px;height:22px}
    .danger{border-color:#4c1f20;background:#1a1112;color:#ffcccc}
    .btn-full{width:100%}
    .msg{margin-top:8px;font-size:14px}
    .msg.ok{color:#c6f7d0}
    .msg.err{color:#ffc9c9}
    .r{position:absolute;border-radius:50%;transform:translate(-50%,-50%) scale(0);
      background:rgba(211,168,91,.25);width:24px;height:24px;pointer-events:none;opacity:.9;
      animation:ripple-kf 600ms ease-out forwards}
    @keyframes ripple-kf{to{transform:translate(-50%,-50%) scale(3.2);opacity:0}}
  </style>
</head>
<body>

<main class="app">
  <header class="topbar">
    <a class="back ripple" href="clientpage.html" aria-label="Voltar">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </a>
    <h1>Perfil</h1>
  </header>

  <div class="wrap">
    <!-- Cabeçalho do perfil -->
    <section class="panel reveal">
      <div class="ph">
        <div class="avatar" id="avatarBox" aria-label="Foto do perfil"></div>
        <div>
          <div id="phName" style="font:600 16px/1.1 Poppins">—</div>
          <div id="phEmail" class="muted" style="font-size:13px">—</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <label class="edit-photo ripple" for="avatarInput">Trocar foto</label>
        <button class="edit-photo ripple" id="removeAvatar" type="button">Remover foto</button>
      </div>
      <input id="avatarInput" type="file" accept="image/*" hidden>
    </section>

    <!-- Dados pessoais -->
    <form class="panel reveal" id="formProfile" novalidate>
      <h2>Dados pessoais</h2>
      <div class="field">
        <label class="label" for="name">Nome</label>
        <input class="input" id="name" name="name" type="text" required>
      </div>
      <div class="field">
        <label class="label" for="email">E-mail</label>
        <input class="input" id="email" name="email" type="email" required>
      </div>
      <div class="field">
        <label class="label" for="phone">Telefone</label>
        <input class="input" id="phone" name="phone" type="tel" inputmode="tel" placeholder="(00) 90000-0000">
      </div>
      <button class="btn btn-primary ripple" type="submit">Salvar alterações</button>
      <div id="msgProfile" class="msg"></div>
    </form>

    <!-- Segurança -->
    <form class="panel reveal" id="formPwd" novalidate>
      <h2>Segurança</h2>
      <div class="grid-2">
        <div class="field">
          <label class="label" for="cur">Senha atual</label>
          <input class="input" id="cur" type="password" autocomplete="current-password" required>
        </div>
        <div class="field">
          <label class="label" for="new">Nova senha</label>
          <input class="input" id="new" type="password" autocomplete="new-password" minlength="6" required>
        </div>
      </div>
      <div class="field">
        <label class="label" for="new2">Confirmar nova senha</label>
        <input class="input" id="new2" type="password" autocomplete="new-password" minlength="6" required>
      </div>
      <button class="btn ripple" type="submit">Atualizar senha</button>
      <div id="msgPwd" class="msg"></div>
    </form>

    <!-- Preferências -->
    <section class="panel reveal">
      <h2>Preferências</h2>
      <div class="switch">
        <label for="prefNotify">Notificações gerais</label>
        <input id="prefNotify" type="checkbox">
      </div>
      <div class="switch">
        <label for="prefRemind">Lembretes de agendamento</label>
        <input id="prefRemind" type="checkbox">
      </div>
      <button class="btn ripple" id="savePrefs" type="button">Salvar preferências</button>
      <div id="msgPrefs" class="msg"></div>
    </section>

    <!-- Zona de perigo -->
    <section class="panel reveal">
      <h2>Conta</h2>
      <div class="grid-2">
        <button class="btn ripple" id="logout" type="button">Sair da conta</button>
        <button class="btn danger ripple" id="deleteAcc" type="button">Excluir conta</button>
      </div>
    </section>
  </div>
</main>

<nav class="navbar" role="navigation" aria-label="Principal">
  <a href="index.html" class="active ripple" aria-current="page">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M3 10l9-7 9 7"></path><path d="M9 22V12h6v10"></path>
    </svg>
    Início
  </a>
  <a href="#" class="ripple">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12" y2="8"></line>
    </svg>
    Explorar
  </a>
  <a href="reservas.html" class="ripple">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="4" width="18" height="18" rx="2"></rect>
      <path d="M16 2v4M8 2v4M3 10h18"></path>
    </svg>
    Minhas reservas
  </a>
  <a href="profile.html" class="ripple">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M20 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M4 21v-2a4 4 0 0 1 3-3.87"></path>
      <circle cx="12" cy="7" r="4"></circle>
    </svg>
    Perfil
  </a>
</nav>

<script>
/* ========= SUPABASE ========= */
const SUPABASE_URL = 'https://rlhrnmzlfiyyycrhggjv.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsaHJubXpsZml5eXljcmhnZ2p2Iiwicm9sZSI6InNlcnZpY2Vfcm9zZSIsImlhdCI6MTc1ODM2OTQ5MSwiZXhwIjoyMDczOTQ1NDkxfQ.tF5FGlO9vzK72LF0lUz5nZgevstzmQTePZEudrYM61Y';

/* lê sessão salva (custom e oficial) */
function getSbSession() {
  const custom = localStorage.getItem('sb.session');
  if (custom) {
    try {
      const s = JSON.parse(custom);
      return {
        access_token: s.access_token || s.token || '',
        user: s.user || null,
        user_id: s.user_id || s.user?.id || '',
        user_email: s.user_email || s.user?.email || ''
      };
    } catch {}
  }
  const ref = SUPABASE_URL.split('https://')[1].split('.')[0];
  const key = `sb-${ref}-auth-token`;
  const raw = localStorage.getItem(key);
  if (raw) {
    try {
      const p = JSON.parse(raw); const sess = p?.currentSession || p;
      return {
        access_token: sess?.access_token || '',
        user: sess?.user || null,
        user_id: sess?.user?.id || '',
        user_email: sess?.user?.email || ''
      };
    } catch {}
  }
  return null;
}
const sb = getSbSession();
if (!sb?.access_token) {
  sessionStorage.setItem('postLoginRedirect','profile.html');
  location.href = 'login.html';
}

/* ========= helpers/UI ========= */
const qs = s => document.querySelector(s);
document.addEventListener('click',(e)=>{
  const t=e.target.closest('.ripple'); if(!t) return;
  const r=document.createElement('span'); r.className='r';
  const b=t.getBoundingClientRect(); r.style.left=(e.clientX-b.left)+'px'; r.style.top=(e.clientY-b.top)+'px';
  t.appendChild(r); r.addEventListener('animationend',()=>r.remove());
},{passive:true});
const io = new IntersectionObserver(ents=>{ents.forEach(en=>{if(en.isIntersecting){en.target.classList.add('is-in');io.unobserve(en.target);}});},{threshold:.12});
document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

/* ========= estado + avatar POR USUÁRIO ========= */
let activeUser = { id:'', name:'Cliente', email:'', phone:'' };
const avatarKey = (id, email) => `avatar:${id || email || 'anon'}`;
let AVATAR_KEY = avatarKey('', ''); // será atualizado após carregar o usuário

function getAvatar() {
  const legacy = localStorage.getItem('auth.avatar');   // migração da chave antiga
  if (legacy && AVATAR_KEY) {
    localStorage.setItem(AVATAR_KEY, legacy);
    localStorage.removeItem('auth.avatar');
  }
  return localStorage.getItem(AVATAR_KEY);
}
const initials = n => (n||' ').trim().split(/\s+/).slice(0,2).map(p=>p[0]?.toUpperCase()||'').join('');

function renderHeader(){
  const box = qs('#avatarBox'); box.innerHTML = '';
  const data = getAvatar();
  if (data) {
    const img = new Image(); img.src = data; img.alt='Foto do perfil';
    box.appendChild(img);
  } else {
    box.textContent = initials(activeUser.name);
  }
  qs('#phName').textContent  = activeUser.name || '—';
  qs('#phEmail').textContent = activeUser.email || '—';
}
function fillForm(){
  qs('#name').value  = activeUser.name  || '';
  qs('#email').value = activeUser.email || '';
  qs('#phone').value = activeUser.phone || '';
}

/* ========= carregar do Auth (email + user_metadata) ========= */
async function loadFromAuth() {
  try {
    const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      method: 'GET',
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${sb.access_token}` }
    });
    if (!res.ok) throw new Error(await res.text());
    const u = await res.json();
    activeUser.id    = u.id || sb.user_id || '';
    activeUser.email = u.email || sb.user_email || '';
    activeUser.name  = (u.user_metadata?.full_name || '').trim() || 'Cliente';
    activeUser.phone = u.user_metadata?.phone || '';
  } catch (e) {
    console.error('Auth load error:', e);
    const meta = sb?.user?.user_metadata || {};
    activeUser = {
      id: sb?.user_id || sb?.user?.id || '',
      email: sb?.user_email || sb?.user?.email || '',
      name: (meta.full_name || '').trim() || 'Cliente',
      phone: meta.phone || ''
    };
  } finally {
    AVATAR_KEY = avatarKey(activeUser.id, activeUser.email);
    renderHeader();
    fillForm();
  }
}
loadFromAuth();

/* ========= trocar/remover foto ========= */
qs('#avatarInput').addEventListener('change', (ev)=>{
  const file = ev.target.files?.[0]; if(!file) return;
  const rd = new FileReader();
  rd.onload = () => {
    if (!AVATAR_KEY) AVATAR_KEY = avatarKey(activeUser.id, activeUser.email);
    localStorage.setItem(AVATAR_KEY, rd.result);
    renderHeader();
  };
  rd.readAsDataURL(file);
});
qs('#removeAvatar').addEventListener('click', ()=>{
  if (!AVATAR_KEY) return;
  localStorage.removeItem(AVATAR_KEY);
  renderHeader();
});

/* ========= salvar no Auth (email + user_metadata) ========= */
qs('#formProfile').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = qs('#msgProfile');
  const name  = qs('#name').value.trim();
  const email = qs('#email').value.trim().toLowerCase();
  const phone = qs('#phone').value.trim();

  if(!name || !/^\S+@\S+\.\S+$/.test(email)){
    msg.className='msg err'; msg.textContent='Verifique nome e e-mail.'; return;
  }
  try{
    const r = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      method:'PUT',
      headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${sb.access_token}`, 'Content-Type':'application/json' },
      body: JSON.stringify({ email, data:{ full_name: name, phone } })
    });
    if(!r.ok){
      // poucos projetos permitem trocar email sem verificação; se falhar, atualiza só metadata
      const metaOnly = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        method:'PUT',
        headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${sb.access_token}`, 'Content-Type':'application/json' },
        body: JSON.stringify({ data:{ full_name: name, phone } })
      });
      if(!metaOnly.ok) throw new Error(await metaOnly.text());
    }
    activeUser.name = name; activeUser.email = email; activeUser.phone = phone;
    AVATAR_KEY = avatarKey(activeUser.id, activeUser.email); // caso o e-mail mude
    renderHeader(); fillForm();
    msg.className='msg ok'; msg.textContent='Dados atualizados!';
    setTimeout(()=>msg.textContent='', 1400);
  }catch(err){
    console.error(err);
    msg.className='msg err'; msg.textContent='Falha ao salvar. Tente novamente.';
  }
});

/* ========= trocar senha ========= */
qs('#formPwd').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = qs('#msgPwd');
  const nw  = qs('#new').value;
  const nw2 = qs('#new2').value;

  if(nw.length < 6){ msg.className='msg err'; msg.textContent='Nova senha deve ter 6+ caracteres.'; return; }
  if(nw !== nw2){ msg.className='msg err'; msg.textContent='Confirmação não confere.'; return; }

  try{
    const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      method:'PUT',
      headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${sb.access_token}`, 'Content-Type':'application/json' },
      body: JSON.stringify({ password: nw })
    });
    if(!res.ok) throw new Error(await res.text());
    qs('#cur').value = qs('#new').value = qs('#new2').value = '';
    msg.className='msg ok'; msg.textContent='Senha atualizada com sucesso!';
    setTimeout(()=>msg.textContent='', 1400);
  }catch(err){
    console.error(err);
    msg.className='msg err'; msg.textContent='Falha ao atualizar a senha.';
  }
});

/* ========= preferências (local) ========= */
const prefs = JSON.parse(localStorage.getItem('prefs') || '{"notify":true,"remind":true}');
qs('#prefNotify').checked = !!prefs.notify;
qs('#prefRemind').checked = !!prefs.remind;
qs('#savePrefs').addEventListener('click', ()=>{
  const msg = qs('#msgPrefs');
  const out = { notify: qs('#prefNotify').checked, remind: qs('#prefRemind').checked };
  localStorage.setItem('prefs', JSON.stringify(out));
  msg.className='msg ok'; msg.textContent='Preferências salvas!';
  setTimeout(()=>msg.textContent='', 1400);
});

/* ========= sair / excluir ========= */
function cleanSessionKeys(){
  try{
    if (AVATAR_KEY) localStorage.removeItem(AVATAR_KEY);   // foto desse usuário
    localStorage.removeItem('auth.avatar');                // chave legacy
    const ref = SUPABASE_URL.split('https://')[1].split('.')[0];
    localStorage.removeItem(`sb-${ref}-auth-token`);
    localStorage.removeItem('sb.session');
  }catch{}
}
qs('#logout').addEventListener('click', async ()=>{
  try{
    await fetch(`${SUPABASE_URL}/auth/v1/logout`, {
      method:'POST', headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${sb.access_token}` }
    }).catch(()=>{});
  } finally {
    cleanSessionKeys();
    location.href='login.html';
  }
});
qs('#deleteAcc').addEventListener('click', async ()=>{
  if(!confirm('Tem certeza que deseja excluir sua conta? Essa ação não pode ser desfeita.')) return;
  try{
    await fetch(`${SUPABASE_URL}/auth/v1/logout`, {
      method:'POST', headers:{ apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${sb.access_token}` }
    }).catch(()=>{});
  } finally {
    cleanSessionKeys();
    location.href='login.html';
  }
});
</script>
</body>
</html>
