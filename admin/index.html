<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Dashboard • Mineiro Barbershop</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===================== Tokens (reutiliza os do app) ===================== */
:root{
  --bg:#0f0f10;
  --panel:#141416;
  --panel-2:#101113;
  --text:#f5f6f9;
  --muted:#a7aab3;
  --line:#22242a;
  --gold:#d3a85b;
  --gold-2:#b88f49;
  --gold-rgb:211,168,91;
  --danger:#ff4d4f;
  --shadow:0 18px 50px rgba(0,0,0,.35);
  --dur:360ms;
  --ease:cubic-bezier(.22,1,.36,1);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:#0b0c0e;color:var(--text);
  font:15px/1.6 Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}

/* ===================== Layout ===================== */
.app{
  min-height:100svh;
  display:grid;
  grid-template-columns:280px 1fr;
  grid-template-rows:auto 1fr;
  grid-template-areas:
    "sidebar header"
    "sidebar main";
  background:var(--bg);
}

/* Sidebar */
.sidebar{
  grid-area:sidebar;
  background:linear-gradient(180deg,#0f1012,#0e0f11);
  border-right:1px solid var(--line);
  padding:18px 14px;
  position:sticky; top:0; height:100svh;
  display:flex; flex-direction:column; gap:14px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  padding:10px; border:1px solid var(--line); border-radius:12px;
  background:var(--panel);
}
.brand-logo{
  width:38px;height:38px;border-radius:10px;display:grid;place-items:center;
  background:#111; border:1px solid #262830; color:var(--gold); font:800 12px/1 Poppins;
}
.brand strong{font:700 15px/1 Poppins}

.balance{
  padding:14px; border:1px solid var(--line); border-radius:14px;
  background:linear-gradient(180deg,#121317,#0e0f12);
  box-shadow:var(--shadow);
}
.balance small{color:#cfd0d4;display:block}
.balance .money{font:700 22px/1.1 Poppins;margin:6px 0 0;color:var(--text)}
.balance .money::before{content:"$";opacity:.7;margin-right:4px}

.nav{
  display:grid; gap:8px; margin-top:6px;
}
.nav a{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:10px; color:#cfd0d4; text-decoration:none;
  border:1px solid var(--line); background:var(--panel-2);
}
.nav a.active{ color:var(--gold); background:rgba(var(--gold-rgb),.10); border-color:rgba(var(--gold-rgb),.35) }
.nav a svg{ width:18px; height:18px }
.sidebar .spacer{ flex:1 }
.sidebar .subnav{ display:grid; gap:8px }

/* Header */
.header{
  grid-area:header;
  display:flex; align-items:center; gap:12px;
  padding:14px 18px; border-bottom:1px solid var(--line);
  position:sticky; top:0; background:rgba(15,16,18,.86);
  backdrop-filter: blur(6px) saturate(115%);
  z-index:10;
}
.search{
  flex:1; min-width:0; display:grid; grid-template-columns:18px 1fr; gap:10px;
  align-items:center; height:44px; padding:0 12px; border-radius:12px;
  background:#131418; border:1px solid #23252b; color:#cfd0d4;
}
.search input{ background:transparent; border:0; outline:0; color:inherit; font:500 13px/1 Poppins }
.uinfo{
  display:flex; align-items:center; gap:10px; margin-left:auto;
}
.uinfo .avatar{
  width:36px; height:36px; border-radius:10px; object-fit:cover;
  border:1px solid rgba(255,255,255,.1);
}
.uinfo .name{ font:600 13px/1 Poppins }
.uinfo .role{ color:#aeb2bb; font-size:12px }

/* Main */
.main{
  grid-area:main;
  padding:18px;
  display:grid; gap:16px;
  grid-template-columns: 1.35fr .95fr; /* conteúdo / lateral */
}
@media (max-width: 1024px){
  .app{ grid-template-columns: 88px 1fr }
  .brand strong{ display:none }
  .nav a span{ display:none }
  .main{ grid-template-columns:1fr }
}
@media (max-width: 680px){
  .app{ grid-template-columns:1fr; grid-template-areas:"header" "main" }
  .sidebar{ position:fixed; inset:auto 0 0 0; height:auto; flex-direction:row; overflow:auto; z-index:99; }
  .sidebar .spacer{ display:none }
  .header{ top:0 }
  body{ padding-bottom:86px } /* espaço p/ sidebar fixa embaixo */
}

/* Cards & grids */
.grid{
  display:grid; gap:14px;
}
.cards3{ grid-template-columns: repeat(3, 1fr) }
.cards2{ grid-template-columns: repeat(2, 1fr) }
@media (max-width: 1024px){
  .cards3{ grid-template-columns: repeat(2, 1fr) }
}
@media (max-width: 560px){
  .cards3, .cards2{ grid-template-columns: 1fr }
}

.card{
  background:var(--panel); border:1px solid var(--line); border-radius:14px;
  padding:14px; box-shadow:var(--shadow);
}
.card h3{
  margin:0 0 10px; font:600 14px/1 Poppins;
}
.kpi{
  display:flex; align-items:center; gap:12px;
  padding:12px; border-radius:12px; border:1px solid var(--line); background:var(--panel-2);
}
.kpi .ico{
  width:40px;height:40px;border-radius:12px;display:grid;place-items:center;
  background:#1b1c20;border:1px solid #2a2c33;color:#f1f2f6;
}
.kpi .label{ color:#cfd0d4; font:600 12px/1 Poppins }
.kpi .value{ font:700 18px/1.1 Poppins }

.subtle{ color:#aeb2bb; font-size:12px }
.tag{
  display:inline-grid; place-items:center; height:22px; padding:0 8px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:#111214; font:700 11px/1 Poppins; letter-spacing:.03em;
}
.tag--up{ color:#7ef7a0; border-color:rgba(126,247,160,.25); background:rgba(126,247,160,.08) }
.tag--down{ color:#ff9aa0; border-color:rgba(255,154,160,.25); background:rgba(255,154,160,.08) }

.list{
  display:grid; gap:10px;
}
.item{
  display:flex; align-items:center; gap:10px;
  padding:10px; border-radius:12px; border:1px solid var(--line); background:var(--panel-2);
}
.item .bullet{
  width:32px;height:32px;border-radius:10px;display:grid;place-items:center;
  background:#1b1c20;border:1px solid #2a2c33;color:#f1f2f6;
}
.item .meta{ min-width:0; }
.item .meta .t{ font:600 13px/1.1 Poppins; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.item .meta .s{ color:#aeb2bb; font-size:12px }

/* Chart canvas wrapper */
.chart-wrap{
  height:240px; border:1px dashed #2a2c33; border-radius:12px;
  display:grid; place-items:center; overflow:hidden; background:linear-gradient(180deg,#101114,#0c0d10);
}
canvas{ width:100%; height:100% }

/* Little map placeholder */
.mapph{
  height:240px; border:1px dashed #2a2c33; border-radius:12px;
  display:grid; place-items:center; color:#aeb2bb; background:linear-gradient(180deg,#101114,#0c0d10);
}

/* Buttons */
.btn{
  height:36px; padding:0 12px; border-radius:10px; border:1px solid var(--line);
  background:#1b1c20; color:#e6e7ea; font:600 12px/1 Poppins; cursor:pointer;
}
.btn-primary{
  border-color:#7b6335; background:linear-gradient(180deg,var(--gold),var(--gold-2)); color:#111;
}

/* Helpers */
.row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
.sep{ height:1px; background:var(--line); margin:8px -14px }

/* Hover/focus */
a, .btn{ transition:transform .12s ease, border-color .2s, background .2s, color .2s }
a:hover, .btn:hover{ transform: translateY(-1px) }
</style>
</head>
<body>

<div class="app">
  <!-- ===================== Sidebar ===================== -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">MB</div>
      <strong>Mineiro Barbershop</strong>
    </div>

    <div class="balance">
      <small>Saldo</small>
      <div class="money" id="balance">$ 0</div>
    </div>

    <nav class="nav">
      <a class="active" href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2 4 4 8-8 4 4"/></svg><span>Dashboard</span></a>
      <a href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v4H3zM3 10h18v11H3z"/><path d="M7 10v11M17 10v11"/></svg><span>Insight</span></a>
      <a href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg><span>Transações</span></a>
      <a href="https://barber-lovat-eight.vercel.app/admin/services"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg><span>Serviços</span></a>
      <a href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0 1 13 0"/></svg><span>Conta</span></a>
      <a href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M5 4h14M5 9h14M5 14h14M5 19h14"/></svg><span>Configurações</span></a>
    </nav>

    <div class="spacer"></div>

    <div class="subnav">
      <button class="btn">Adicionar conta</button>
      <button class="btn">Trocar conta</button>
      <button class="btn">Sair</button>
    </div>
  </aside>

  <!-- ===================== Header ===================== -->
  <header class="header">
    <div class="search">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-3.5-3.5"/>
      </svg>
      <input type="search" placeholder="Buscar…" aria-label="Buscar">
    </div>

    <div class="uinfo">
      <div class="row">
        <span class="name">Cláudia Alves</span>
        <span class="tag">Admin</span>
      </div>
      <img class="avatar" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=120&q=80" alt="Usuária">
    </div>
  </header>

  <!-- ===================== Main ===================== -->
  <main class="main">
    <!-- COLUNA PRINCIPAL -->
    <section class="grid">
      <!-- KPIs -->
      <div class="grid cards3">
        <div class="card kpi">
          <div class="ico"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9M13 17v-3M8 17v-1"/></svg></div>
          <div>
            <div class="label">Receita (30d)</div>
            <div class="value" id="kpi-revenue">R$ 0</div>
          </div>
          <span class="tag tag--up" id="kpi-revenue-delta">+0%</span>
        </div>
        <div class="card kpi">
          <div class="ico"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7V3h8v4"/><rect x="3" y="7" width="18" height="14" rx="2"/></svg></div>
          <div>
            <div class="label">Atendimentos</div>
            <div class="value" id="kpi-visits">0</div>
          </div>
          <span class="tag" id="kpi-avg-ticket">Ticket R$ 0</span>
        </div>
        <div class="card kpi">
          <div class="ico"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 7l-1 12H6L5 7"/><path d="M10 11v6M14 11v6"/><path d="M4 7h16"/></svg></div>
          <div>
            <div class="label">No-show</div>
            <div class="value" id="kpi-noshow">0</div>
          </div>
          <span class="tag tag--down" id="kpi-noshow-rate">0%</span>
        </div>
      </div>

      <!-- Gráfico -->
      <div class="card">
        <h3>Receita por dia (30d)</h3>
        <div class="chart-wrap"><canvas id="barChart" aria-label="Gráfico de barras" role="img"></canvas></div>
      </div>

      <!-- Minhas Métricas Salvas -->
      <div class="card">
        <h3>Minhas métricas salvas</h3>
        <div class="list" id="savedMetrics">
          <div class="item">
            <div class="bullet">📅</div>
            <div class="meta">
              <div class="t">Agendamentos / Contato</div>
              <div class="s subtle">Último mês • Unidade Centro</div>
            </div>
            <span class="tag tag--up">+12%</span>
          </div>
          <div class="item">
            <div class="bullet">☎️</div>
            <div class="meta">
              <div class="t">Tentativas de contato</div>
              <div class="s subtle">Último mês • Instagram Ads</div>
            </div>
            <span class="tag tag--up">+7%</span>
          </div>
          <div class="item">
            <div class="bullet">✅</div>
            <div class="meta">
              <div class="t">Aprovação de orçamento</div>
              <div class="s subtle">Último mês • Todos os canais</div>
            </div>
            <span class="tag tag--down">-3%</span>
          </div>
        </div>
      </div>
    </section>

    <!-- COLUNA LATERAL -->
    <aside class="grid">
      <!-- Estatísticas rápidas -->
      <div class="card">
        <h3>Estatísticas rápidas</h3>
        <div class="list" id="quickStats">
          <div class="item">
            <div class="bullet">💈</div>
            <div class="meta">
              <div class="t">Top Serviço (30d)</div>
              <div class="s subtle" id="top-service">Corte masculino</div>
            </div>
            <span class="tag" id="top-service-qty">0x</span>
          </div>
          <div class="item">
            <div class="bullet">👤</div>
            <div class="meta">
              <div class="t">Novos clientes (30d)</div>
              <div class="s subtle">Primeira visita</div>
            </div>
            <span class="tag" id="new-customers">0</span>
          </div>
          <div class="item">
            <div class="bullet">🧑‍🔧</div>
            <div class="meta">
              <div class="t">Top Profissional</div>
              <div class="s subtle" id="top-pro">—</div>
            </div>
            <span class="tag" id="top-pro-gross">R$ 0</span>
          </div>
        </div>
      </div>

      <!-- Por região -->
      <div class="card">
        <h3>Por região</h3>
        <div class="mapph">Mapa/heatmap (em breve)</div>
        <div class="row" style="margin-top:10px">
          <span class="tag">50% Centro</span>
          <span class="tag">30% Zona Norte</span>
          <span class="tag">20% Outros</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script>
const els = {
  balance:       ()=>document.getElementById('balance'),
  rev:           ()=>document.getElementById('kpi-revenue'),
  revDelta:      ()=>document.getElementById('kpi-revenue-delta'),
  visits:        ()=>document.getElementById('kpi-visits'),
  ticket:        ()=>document.getElementById('kpi-avg-ticket'),
  ns:            ()=>document.getElementById('kpi-noshow'),
  nsRate:        ()=>document.getElementById('kpi-noshow-rate'),
  newCust:       ()=>document.getElementById('new-customers'),
  topServ:       ()=>document.getElementById('top-service'),
  topServQty:    ()=>document.getElementById('top-service-qty'),
  topPro:        ()=>document.getElementById('top-pro'),
  topProGross:   ()=>document.getElementById('top-pro-gross'),
  chart:         ()=>document.getElementById('barChart'),
  // filtros
  filterDays:    ()=>document.getElementById('f-days'),
  filterPro:     ()=>document.getElementById('f-pro'),
  filterBtn:     ()=>document.getElementById('f-apply'),
  toast:         ()=>document.getElementById('toast')
};

function fmtBRL(n){ return Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function setText(el, v){ if(el) el.textContent = v; }
function showToast(msg, ok=false){
  const el = els.toast(); if(!el) return;
  el.textContent = msg;
  el.style.background = ok ? 'rgba(126,247,160,.14)' : 'rgba(255,154,160,.14)';
  el.style.border = ok ? '1px solid rgba(126,247,160,.35)' : '1px solid rgba(255,154,160,.35)';
  el.style.display = 'block';
  setTimeout(()=> el.style.display='none', 2800);
}

async function fetchMetrics(params){
  const u = new URL('https://primary-jow9-barber.up.railway.app/webhook/metrics', window.location.origin);
  Object.entries(params).forEach(([k,v]) => v!=='' && u.searchParams.set(k,String(v)));
  const r = await fetch(u, { headers: { 'accept':'application/json' } });
  if(!r.ok) throw new Error('Falha ao buscar métricas');
  return await r.json();
}

function renderMetrics(data){
  setText(els.balance(), fmtBRL(data.balance));
  setText(els.rev(), fmtBRL(data.kpis.revenue30d));
  setText(els.revDelta(), `${data.kpis.revenueDelta>=0?'+':''}${(data.kpis.revenueDelta||0).toFixed(1)}%`);
  setText(els.visits(), data.kpis.visits);
  setText(els.ticket(), 'Ticket '+fmtBRL(data.kpis.avgTicket));
  setText(els.ns(), data.kpis.noShow);
  setText(els.nsRate(), (data.kpis.noShowRate||0).toFixed(1)+'%');
  setText(els.newCust(), data.kpis.newCustomers30d);
  setText(els.topServ(), data.top.service?.name || '—');
  setText(els.topServQty(), (data.top.service?.qty||0)+'x');
  setText(els.topPro(), data.top.pro?.name || '—');
  setText(els.topProGross(), fmtBRL(data.top.pro?.gross || 0));
  drawBarChart('barChart', data.chart || []);
}

function drawBarChart(canvasId, data){
  const c = document.getElementById(canvasId);
  if(!c) return;
  const dpr = window.devicePixelRatio || 1;
  const W = c.clientWidth, H = c.clientHeight;
  c.width = W*dpr; c.height = H*dpr;
  const ctx = c.getContext('2d'); ctx.scale(dpr,dpr);

  ctx.fillStyle = '#0e0f12'; ctx.fillRect(0,0,W,H);
  const pad = 28, max = Math.max(1, ...(data.map(d=>d.value||0)));
  ctx.strokeStyle = '#23252b'; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();

  const n = data.length, gap = 6;
  const bw = (W - pad*2 - (n-1)*gap) / (n||1);
  for(let i=0;i<n;i++){
    const v = data[i].value||0;
    const h = Math.max(4, (v/max)*(H-pad*2));
    const x = pad + i*(bw+gap);
    const y = H - pad - h;

    const g = ctx.createLinearGradient(0,y,0,y+h);
    g.addColorStop(0,'#d3a85b'); g.addColorStop(1,'#b88f49');
    ctx.fillStyle = g; ctx.fillRect(x,y,bw,h);
    ctx.fillStyle = 'rgba(0,0,0,.2)'; ctx.fillRect(x+bw-2,y,2,h);

    if(n<=14){
      ctx.fillStyle = '#8e93a1'; ctx.font = '10px Poppins'; ctx.textAlign='center';
      ctx.fillText(data[i].label||'', x+bw/2, H-10);
    }
  }
}

/** Filtros UI */
function buildFilters(){
  const toolbar = document.createElement('div');
  toolbar.className = 'card';
  toolbar.innerHTML = `
    <h3 style="margin-bottom:8px">Filtros</h3>
    <div class="row">
      <select id="f-days" class="btn">
        <option value="7">Últimos 7 dias</option>
        <option value="30" selected>Últimos 30 dias</option>
        <option value="90">Últimos 90 dias</option>
      </select>
      <select id="f-pro" class="btn"><option value="">Todos profissionais</option></select>
      <button id="f-apply" class="btn btn-primary">Aplicar</button>
      <span id="toast" class="tag" style="display:none"></span>
    </div>`;
  const main = document.querySelector('.main > .grid');
  main?.insertAdjacentElement('afterbegin', toolbar);
}

/** Carrega profissionais no select */
function fillProfessionals(list){
  const sel = els.filterPro(); if(!sel) return;
  sel.innerHTML = `<option value="">Todos profissionais</option>` +
    (list||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}

/** Boot */
async function init(){
  buildFilters();

  try{
    const data = await fetchMetrics({ days: 30 });
    fillProfessionals(data.professionals);
    renderMetrics(data);
    showToast('Métricas carregadas', true);
  }catch(e){ showToast('Erro ao carregar métricas'); console.error(e); }

  els.filterBtn()?.addEventListener('click', async ()=>{
    const days = els.filterDays()?.value || '30';
    const pro  = els.filterPro()?.value || '';
    try{
      showToast('Atualizando…', true);
      const data = await fetchMetrics({ days, pro_id: pro });
      renderMetrics(data);
      showToast('Atualizado', true);
    }catch(e){ showToast('Erro ao atualizar'); console.error(e); }
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
