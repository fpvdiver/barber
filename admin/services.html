<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Servi√ßos ‚Äî CRUD (Supabase + n8n)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#131720; --line:#1f2430;
    --text:#f5f7fb; --muted:#a7b0c0;
    --brand:#0a6ebd; --brand-2:#094f8a; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px; --chip:#1a2030; --shadow:0 18px 50px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:14px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:1040px;margin:28px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  h1{font-size:20px;margin:0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,select,textarea{background:#0d111a;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px 12px;width:100%}
  label{font-size:12px;color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--line);background:var(--brand);color:#fff;
       padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.secondary{background:#0d111a;color:#fff}
  .btn.danger{background:var(--danger);border-color:#9f1239}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-top:1px solid var(--line)}
  thead th{background:#0c1220;color:#cbd5e1;text-align:left;border-top:none}
  tbody tr:nth-child(odd) td{background:#0f1422}
  .pill{padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px;border:1px solid var(--line);background:var(--chip);color:#d1d8e6}
  .right{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .search{display:flex;gap:8px}
  .w-120{width:120px}
  .mt-8{margin-top:8px}
  .mt-12{margin-top:12px}
  .mb-8{margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üíà Servi√ßos</h1>
    <div class="search">
      <input id="q" placeholder="Buscar por nome‚Ä¶" />
      <select id="filterActive" class="w-120">
        <option value="">Todos</option>
        <option value="true">Ativos</option>
        <option value="false">Inativos</option>
      </select>
      <button class="btn" id="btnReload">Recarregar</button>
    </div>
  </header>

  <div class="grid">
    <!-- Lista -->
    <section class="card">
      <div class="row right mb-8">
        <span class="muted">Listagem</span>
        <span id="count" class="pill">0</span>
      </div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Pre√ßo</th>
              <th>Dura√ß√£o</th>
              <th>Ativo</th>
              <th class="right">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Form -->
    <aside class="card">
      <h3 class="mb-8" style="margin:0">Cadastrar / Editar</h3>
      <form id="frm" class="row" onsubmit="return false">
        <input type="hidden" id="id">
        <div style="width:100%"><label>Nome</label><input id="name" required placeholder="Ex.: Corte + Barba Deluxe"></div>
        <div style="width:100%"><label>Descri√ß√£o</label><textarea id="description" rows="3" placeholder="Detalhes do servi√ßo‚Ä¶"></textarea></div>
        <div style="width:50%"><label>Pre√ßo (R$)</label><input id="price" type="number" min="0" step="0.01" required></div>
        <div style="width:50%"><label>Dura√ß√£o (min)</label><input id="duration" type="number" min="5" step="5" required></div>
        <div style="width:60%"><label>Categoria</label><input id="category" placeholder="Ex.: Cabelo, Barba, Combo"></div>
        <div style="width:40%"><label>Ativo</label>
          <select id="active"><option value="true">Sim</option><option value="false">N√£o</option></select>
        </div>
        <div class="row mt-12">
          <button class="btn" id="btnSave">Salvar</button>
          <button class="btn secondary" id="btnClear" type="button">Limpar</button>
          <button class="btn danger" id="btnDelete" type="button" disabled>Excluir</button>
        </div>
      </form>
    </aside>
  </div>
</div>

<script>
/** ====== CONFIG ====== **/
const N8N_BASE_URL = 'https://primary-jow9-barber.up.railway.app/webhook/services';
const PUBLIC_API_KEY = '78c212eafa48e2528d81c5937af5c8ba0825d9895ebe9da4'; // precisa bater com o Code node
const ENVIAR_DESCRIPTION = false; // mude para true se a coluna existir na tabela

/** ====== Helpers ====== **/
const $ = sel => document.querySelector(sel);
const fmtBRL = cents => (cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function formToPayload() {
  const price = parseFloat($('#price').value || '0');
  const payload = {
    id: $('#id').value || undefined,
    name: $('#name').value.trim(),
    price_cents: Math.round(price * 100),
    duration_min: parseInt($('#duration').value,10),
    category: $('#category').value.trim() || null,
    is_active: $('#active').value === 'true'
  };
  if (ENVIAR_DESCRIPTION) payload.description = $('#description').value.trim() || null;
  return payload;
}

function fillForm(s = {}) {
  $('#id').value = s.id || '';
  $('#name').value = s.name || '';
  $('#description').value = (s.description ?? '') || '';
  $('#price').value = s.price_cents ? (s.price_cents/100).toFixed(2) : '';
  $('#duration').value = s.duration_min ?? '';
  $('#category').value = s.category ?? '';
  $('#active').value = String(!!(s.is_active ?? s.active));
  $('#btnDelete').disabled = !s.id;
}

/** ====== CRUD via n8n ====== **/
async function listServices() {
  try {
    const q = encodeURIComponent($('#q').value.trim());
    const active = $('#filterActive').value;

    const url = new URL(N8N_BASE_URL);
    url.searchParams.set('limit', '500');
    if (q) url.searchParams.set('search', q);
    if (active) url.searchParams.set('active', active);
    url.searchParams.set('_', String(Date.now())); // anti-cache

    const headers = {};
    // Se seu GET no n8n exige x-api-key, descomente:
    // headers['x-api-key'] = PUBLIC_API_KEY;

    const res = await fetch(url.toString(), { method:'GET', headers });
    if (!res.ok) {
      const t = await res.text().catch(()=> '');
      throw new Error(`GET ${res.status}: ${t || 'Falha ao listar'}`);
    }

    let body = null;
    try { body = await res.json(); } catch {}

    let items = [];
    if (Array.isArray(body)) {
      items = body.map(x => x?.json ?? x);
    } else if (body?.data && Array.isArray(body.data)) {
      items = body.data;
    } else if (body && typeof body === 'object') {
      const vals = Object.values(body);
      if (vals.length && typeof vals[0] === 'object') {
        items = vals.map(v => v?.json ?? v);
      }
    }

    renderTable(items);
  } catch (err) {
    console.error(err);
    alert('Erro ao carregar servi√ßos: ' + (err.message || err));
    renderTable([]);
  }
}

async function createService(payload) {
  const res = await fetch(N8N_BASE_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'x-api-key': PUBLIC_API_KEY },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`POST ${res.status}: ${t || 'Falha ao criar'}`);
  }
  return res.json();
}

async function updateService(payload) {
  const res = await fetch(N8N_BASE_URL, {
    method: 'PATCH',
    headers: { 'Content-Type':'application/json', 'x-api-key': PUBLIC_API_KEY },
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`PATCH ${res.status}: ${t || 'Falha ao atualizar'}`);
  }
  return res.json();
}

async function deleteService(id) {
  const res = await fetch(N8N_BASE_URL, {
    method: 'DELETE',
    headers: { 'Content-Type':'application/json', 'x-api-key': PUBLIC_API_KEY },
    body: JSON.stringify({ id })
  });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`DELETE ${res.status}: ${t || 'Falha ao excluir'}`);
  }
  return res.json();
}

/** ====== UI ====== **/
function renderTable(items) {
  const tbody = $('#tbl tbody');
  tbody.innerHTML = '';
  $('#count').textContent = items.length;

  for (const s of items) {
    const ativo = !!(s.is_active ?? s.active);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.name ?? ''}</td>
      <td>${s.category ?? '-'}</td>
      <td>${fmtBRL(s.price_cents ?? 0)}</td>
      <td>${s.duration_min ?? '-'} min</td>
      <td><span class="pill" style="background:${ativo?'#0f2a18':'#2a0f10'};border-color:${ativo?'#195f3a':'#6b1b1b'}">${ativo?'Ativo':'Inativo'}</span></td>
      <td class="right">
        <button class="btn secondary" data-edit="${s.id}">Editar</button>
        <button class="btn danger" data-del="${s.id}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-edit');
      const s = items.find(x=>x.id===id);
      if(s) fillForm(s);
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  tbody.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del');
      if(confirm('Excluir este servi√ßo?')) {
        try {
          await deleteService(id);
          if($('#id').value===id) fillForm({});
          await listServices();
        } catch(e){ alert(e.message); }
      }
    });
  });
}

/** ====== Eventos ====== **/
$('#btnReload').addEventListener('click', listServices);
$('#q').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(listServices, 300); });
$('#filterActive').addEventListener('change', listServices);
$('#btnClear').addEventListener('click', ()=> fillForm({}));

$('#btnSave').addEventListener('click', async ()=>{
  const payload = formToPayload();
  try{
    if(payload.id) await updateService(payload);
    else await createService(payload);
    fillForm({});
    await listServices();
    alert('Salvo com sucesso!');
  }catch(e){ alert(e.message); }
});

$('#btnDelete').addEventListener('click', async ()=>{
  const id = $('#id').value;
  if(!id) return;
  if(confirm('Excluir este servi√ßo?')){
    try{ await deleteService(id); fillForm({}); await listServices(); }
    catch(e){ alert(e.message); }
  }
});

listServices();
</script>
</body>
</html>

