<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM — Clientes • Mineiro Barbershop</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f0f10; --panel:#141416; --panel-2:#101113;
  --text:#f5f6f9; --muted:#a7aab3; --line:#22242a;
  --gold:#d3a85b; --gold-2:#b88f49; --gold-rgb:211,168,91;
  --danger:#ff4d4f; --shadow:0 18px 50px rgba(0,0,0,.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#0b0c0e;color:var(--text);font:15px/1.6 Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.app{min-height:100svh;display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;grid-template-areas:"sidebar header" "sidebar main";background:var(--bg)}
.sidebar{grid-area:sidebar;background:linear-gradient(180deg,#0f1012,#0e0f11);border-right:1px solid var(--line);padding:18px 14px;position:sticky;top:0;height:100svh;display:flex;flex-direction:column;gap:14px}
.brand{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--panel)}
.brand-logo{width:38px;height:38px;border-radius:10px;display:grid;place-items:center;background:#111;border:1px solid #262830;color:var(--gold);font:800 12px/1 Poppins}
.brand strong{font:700 15px/1 Poppins}
.balance{padding:14px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#121317,#0e0f12);box-shadow:var(--shadow)}
.balance small{color:#cfd0d4;display:block}
.balance .money{font:700 22px/1.1 Poppins;margin:6px 0 0;color:var(--text)}
.nav{display:grid;gap:8px;margin-top:6px}
.nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#cfd0d4;text-decoration:none;border:1px solid var(--line);background:var(--panel-2)}
.nav a.active{color:var(--gold);background:rgba(var(--gold-rgb),.10);border-color:rgba(var(--gold-rgb),.35)}
.nav a svg{width:18px;height:18px}
.sidebar .spacer{flex:1}
.sidebar .subnav{display:grid;gap:8px}
.btn{height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#1b1c20;color:#e6e7ea;font:600 12px/1 Poppins;cursor:pointer}
.btn-primary{border-color:#7b6335;background:linear-gradient(180deg,var(--gold),var(--gold-2));color:#111}
.header{grid-area:header;display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(15,16,18,.86);backdrop-filter:blur(6px) saturate(115%);z-index:10}
.search{flex:1;min-width:0;display:grid;grid-template-columns:18px 1fr 120px;gap:10px;align-items:center;height:44px;padding:0 12px;border-radius:12px;background:#131418;border:1px solid #23252b;color:#cfd0d4}
.search input{background:transparent;border:0;outline:0;color:inherit;font:500 13px/1 Poppins}
.uinfo{display:flex;align-items:center;gap:10px;margin-left:auto}
.uinfo .avatar{width:36px;height:36px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,.1)}
.uinfo .name{font:600 13px/1 Poppins}.uinfo .tag{display:inline-grid;place-items:center;height:22px;padding:0 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#111214;font:700 11px/1 Poppins;letter-spacing:.03em}
.main{grid-area:main;padding:18px;display:grid;gap:16px;grid-template-columns:1fr}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
.card h3{margin:0 0 10px;font:600 14px/1 Poppins}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table thead th{color:#cfd0d4;text-align:left;font:700 12px/1 Poppins;padding:4px 8px 0}
.tr{display:grid;grid-template-columns:220px 170px 220px 1fr 160px 140px;gap:8px;align-items:center;background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:10px}
.badge{display:inline-grid;place-items:center;height:22px;padding:0 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#111214;font:700 11px/1 Poppins;letter-spacing:.03em}
.badge-ok{color:#7ef7a0;border-color:rgba(126,247,160,.25);background:rgba(126,247,160,.08)}
.badge-off{color:#ff9aa0;border-color:rgba(255,154,160,.25);background:rgba(255,154,160,.08)}
.actions{display:flex;gap:8px;justify-content:flex-end}
input[type="text"],input[type="email"],input[type="datetime-local"],textarea,select{height:36px;width:100%;padding:0 10px;border-radius:10px;border:1px solid #23252b;background:#131418;color:#e6e7ea;font:500 13px/1 Poppins}
textarea{min-height:72px;padding:10px}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.sep{height:1px;background:var(--line);margin:8px -14px}
.toast{position:fixed;right:16px;bottom:16px;background:#111214;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:10px;display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px}
.modal .box{width:min(920px,96vw);background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
.modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal .grid .full{grid-column:1 / -1}
@media (max-width:1024px){.app{grid-template-columns:88px 1fr}.brand strong,.nav a span{display:none}.tr{grid-template-columns:200px 150px 200px 1fr 140px 120px}}
@media (max-width:720px){.app{grid-template-columns:1fr;grid-template-areas:"header" "main"}.sidebar{position:fixed;inset:auto 0 0 0;height:auto;flex-direction:row;overflow:auto;z-index:99}.sidebar .spacer{display:none}body{padding-bottom:86px}.tr{grid-template-columns:200px 140px 1fr 140px}}
a,.btn{transition:transform .12s ease,border-color .2s,background .2s,color .2s} a:hover,.btn:hover{transform:translateY(-1px)}
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand"><div class="brand-logo">MB</div><strong>Mineiro Barbershop</strong></div>
    <div class="balance"><small>Saldo</small><div class="money" id="balance">R$ 0</div></div>
    <nav class="nav">
      <a href="index.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2 4 4 8-8 4 4"/></svg><span>Dashboard</span></a>
      <a href="services.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg><span>Serviços</span></a>
      <a class="active" href="clients.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0 1 13 0"/></svg><span>Clientes</span></a>
      <a href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h10"/></svg><span>Transações</span></a>
      <a href="#"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M5 4h14M5 9h14M5 14h14M5 19h14"/></svg><span>Configurações</span></a>
    </nav>
    <div class="spacer"></div>
    <div class="subnav"><button class="btn">Adicionar conta</button><button class="btn">Trocar conta</button><button class="btn">Sair</button></div>
  </aside>

  <!-- Header -->
  <header class="header">
    <div class="search">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-3.5-3.5"/></svg>
      <input id="q" type="text" placeholder="Buscar por nome, telefone ou e-mail…" />
      <select id="activeFilter">
        <option value="">Todos</option>
        <option value="true">Ativos</option>
        <option value="false">Inativos</option>
      </select>
    </div>
    <div class="uinfo">
      <span class="name">Cláudia Alves</span><span class="uinfo tag">Admin</span>
      <img class="avatar" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=120&q=80" alt="Usuária">
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <div class="card">
      <div class="toolbar">
        <button id="btnNew" class="btn btn-primary">+ Novo cliente</button>
        <div style="flex:1"></div>
        <span id="count" class="badge">0 resultados</span>
      </div>

      <div class="sep"></div>

      <div id="rows"></div>

      <div class="pager">
        <button id="prev" class="btn">◀</button>
        <span id="pageInfo" class="badge">Página 1</span>
        <button id="next" class="btn">▶</button>
      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="box">
    <h3 id="modalTitle">Novo cliente</h3>
    <div class="grid" style="margin-top:10px">
      <div>
        <label>Nome</label>
        <input id="f-name" type="text" placeholder="Ex: João Silva" />
      </div>
      <div>
        <label>Telefone</label>
        <input id="f-phone" type="text" placeholder="(31) 9 9999-9999" />
      </div>
      <div>
        <label>E-mail</label>
        <input id="f-email" type="email" placeholder="email@exemplo.com" />
      </div>
      <div>
        <label>Última visita</label>
        <input id="f-last" type="datetime-local" />
      </div>
      <div class="full">
        <label>Notas</label>
        <textarea id="f-notes" placeholder="Observações importantes…"></textarea>
      </div>
      <div>
        <label>Status</label>
        <select id="f-active">
          <option value="true" selected>Ativo</option>
          <option value="false">Inativo</option>
        </select>
      </div>

      <!-- Acesso (login por e-mail) -->
      <div>
        <label>Criar acesso (e-mail)</label>
        <select id="f-create-login">
          <option value="false" selected>Não</option>
          <option value="true">Criar usuário no Auth</option>
        </select>
      </div>
      <div>
        <label>Enviar convite por e-mail</label>
        <select id="f-send-invite">
          <option value="false" selected>Não</option>
          <option value="true">Sim</option>
        </select>
      </div>
      <div>
        <label>auth_user_id</label>
        <input id="f-auth-id" type="text" placeholder="—" disabled />
      </div>
    </div>
    <div class="sep"></div>
    <div class="toolbar" style="justify-content:flex-end">
      <button id="btnCancel" class="btn">Cancelar</button>
      <button id="btnSave" class="btn btn-primary">Salvar</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================== DADOS (n8n façade) ================== */
const N8N_BASE_URL = 'https://primary-jow9-barber.up.railway.app/webhook/clients';
const PUBLIC_API_KEY = '78c212eafa48e2528d81c5937af5c8ba0825d9895ebe9da4'; // se exigir, mantém

/* ================== UI HELPERS ================== */
const els = {
  q: () => document.getElementById('q'),
  activeFilter: () => document.getElementById('activeFilter'),
  rows: () => document.getElementById('rows'),
  count: () => document.getElementById('count'),
  pageInfo: () => document.getElementById('pageInfo'),
  prev: () => document.getElementById('prev'),
  next: () => document.getElementById('next'),
  modal: () => document.getElementById('modal'),
  modalTitle: () => document.getElementById('modalTitle'),
  toast: () => document.getElementById('toast'),
  // form
  fName: () => document.getElementById('f-name'),
  fPhone: () => document.getElementById('f-phone'),
  fEmail: () => document.getElementById('f-email'),
  fLast: () => document.getElementById('f-last'),
  fNotes: () => document.getElementById('f-notes'),
  fActive: () => document.getElementById('f-active'),
  btnSave: () => document.getElementById('btnSave'),
  btnCancel: () => document.getElementById('btnCancel'),
  btnNew: () => document.getElementById('btnNew'),
  // acesso
  fCreateLogin: () => document.getElementById('f-create-login'),
  fSendInvite:  () => document.getElementById('f-send-invite'),
  fAuthId:      () => document.getElementById('f-auth-id'),
};

function toast(msg, ok=true){
  const t = els.toast(); t.textContent = msg;
  t.style.display = 'block';
  t.style.border = ok ? '1px solid rgba(126,247,160,.35)' : '1px solid rgba(255,154,160,.35)';
  t.style.background = ok ? 'rgba(126,247,160,.10)' : 'rgba(255,154,160,.10)';
  setTimeout(()=> t.style.display='none', 2400);
}
function maskPhone(v){
  return (v||'').replace(/\D/g,'')
    .replace(/^(\d{2})(\d)/, '($1) $2')
    .replace(/(\d{5})(\d{4}).*/, '$1-$2');
}

/* ================== STATE ================== */
let page = 1;
const PAGE_SIZE = 10;
let allRows = [];
let editingId = null;

/* ================== DATA LAYER (n8n) ================== */
async function fetchClientsFromApi(){
  const q = els.q().value.trim();
  const active = els.activeFilter().value;

  const url = new URL(N8N_BASE_URL);
  url.searchParams.set('limit','500');
  if(q) url.searchParams.set('search', q);
  if(active) url.searchParams.set('active', active);
  url.searchParams.set('_', String(Date.now()));

  const headers = {
    // 'x-api-key': PUBLIC_API_KEY, // descomente se o fluxo exigir
  };

  const res = await fetch(url.toString(), { method:'GET', headers });
  if(!res.ok){
    const t = await res.text().catch(()=> '');
    throw new Error(`GET ${res.status}: ${t||'Falha ao listar clientes'}`);
  }
  const body = await res.json().catch(()=> null);

  let items = [];
  if(Array.isArray(body)) items = body.map(x=>x?.json ?? x);
  else if(body?.data && Array.isArray(body.data)) items = body.data;
  else if(body && typeof body === 'object'){
    const vals = Object.values(body);
    if(vals.length && typeof vals[0] === 'object') items = vals.map(v=>v?.json ?? v);
  }

  return items;
}

async function createClient(payload){
  const res = await fetch(N8N_BASE_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-api-key': PUBLIC_API_KEY },
    body: JSON.stringify(payload)
  });
  if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(`POST ${res.status}: ${t}`); }
  return res.json();
}
async function updateClient(id, payload){
  const res = await fetch(N8N_BASE_URL, {
    method:'PATCH',
    headers:{ 'Content-Type':'application/json', 'x-api-key': PUBLIC_API_KEY },
    body: JSON.stringify({ id, ...payload })
  });
  if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(`PATCH ${res.status}: ${t}`); }
  return res.json();
}
async function deleteClient(id){
  const res = await fetch(N8N_BASE_URL, {
    method:'DELETE',
    headers:{ 'Content-Type':'application/json', 'x-api-key': PUBLIC_API_KEY },
    body: JSON.stringify({ id })
  });
  if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(`DELETE ${res.status}: ${t}`); }
  return res.json();
}

/* ================== RENDER ================== */
function renderRows(){
  const wrap = els.rows();
  const total = allRows.length;
  if(!total){
    wrap.innerHTML = `<div class="tr" style="grid-template-columns:1fr"><span style="opacity:.8">Nenhum cliente encontrado.</span></div>`;
    els.count().textContent = `0 resultados`;
    els.pageInfo().textContent = `Página 1 / 1`;
    return;
  }

  const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(page > pages) page = pages;
  const from = (page-1)*PAGE_SIZE;
  const slice = allRows.slice(from, from + PAGE_SIZE);

  const html = `
    <div class="tr" style="background:transparent;border:0">
      <strong>Nome</strong>
      <strong>Telefone</strong>
      <strong>E-mail</strong>
      <strong>Notas</strong>
      <strong>Status / Acesso</strong>
      <span></span>
    </div>
    ${slice.map(r=>{
      const hasAuth = !!(r.auth_user_id || r.id);
      const nm = r.full_name || r.name || '—';
      const em = (r.email || '').toLowerCase();
      return `
        <div class="tr" data-id="${r.id}">
          <div>${nm}</div>
          <div>${maskPhone(r.phone)||'—'}</div>
          <div>${em || '—'}</div>
          <div style="color:#aeb2bb">${(r.notes||'—').slice(0,64)}</div>
          <div>
            ${r.is_active ? '<span class="badge badge-ok">Ativo</span>' : '<span class="badge badge-off">Inativo</span>'}
            ${hasAuth ? ' <span class="badge">Login</span>' : ''}
          </div>
          <div class="actions">
            <button class="btn" onclick="onEdit('${r.id}')">Editar</button>
            <button class="btn" onclick="onDelete('${r.id}')">Excluir</button>
          </div>
        </div>
      `;
    }).join('')}
  `;
  wrap.innerHTML = html;

  els.count().textContent = `${total} resultado${total===1?'':'s'}`;
  els.pageInfo().textContent = `Página ${page} / ${pages}`;
}

/* ================== MODAL/FORM ================== */
function openModal(title){ els.modalTitle().textContent = title; els.modal().style.display = 'flex'; }
function closeModal(){ els.modal().style.display = 'none'; editingId = null; clearForm(); }
function fillForm(row){
  els.fName().value   = row?.full_name || row?.name || '';
  els.fPhone().value  = row?.phone || '';
  els.fEmail().value  = (row?.email || '').toLowerCase();
  els.fLast().value   = row?.last_visit_at ? new Date(row.last_visit_at).toISOString().slice(0,16) : '';
  els.fNotes().value  = row?.notes || '';
  els.fActive().value = String( row?.is_active ?? true );

  els.fCreateLogin().value = 'false';
  els.fSendInvite().value  = 'false';
  if (els.fAuthId()) els.fAuthId().value = row?.auth_user_id || row?.id || '';
}
function clearForm(){ fillForm({}) }

/* ================== EVENTS (expostos) ================== */
window.onEdit = function(id){
  const row = allRows.find(r => r.id === id);
  if(!row){ toast('Registro não encontrado', false); return; }
  editingId = id;
  fillForm(row);
  openModal('Editar cliente');
};
window.onDelete = async function(id){
  if(!confirm('Excluir este cliente?')) return;
  try{
    await deleteClient(id);
    toast('Cliente excluído');
    await reload();
  }catch(e){ console.error(e); toast('Erro ao excluir', false); }
};

/* ================== FLOW ================== */
async function reload(){
  try{
    allRows = await fetchClientsFromApi();
    renderRows();
  }catch(e){ console.error(e); toast('Erro ao carregar clientes', false); }
}
function bind(){
  els.q().addEventListener('input', async ()=>{ page=1; await reload(); });
  els.activeFilter().addEventListener('change', async ()=>{ page=1; await reload(); });
  els.prev().addEventListener('click', ()=>{ if(page>1){ page--; renderRows(); } });
  els.next().addEventListener('click', ()=>{ const pages = Math.ceil((allRows.length||0)/PAGE_SIZE)||1; if(page<pages){ page++; renderRows(); } });
  els.btnNew().addEventListener('click', ()=>{ clearForm(); openModal('Novo cliente'); });
  els.btnCancel().addEventListener('click', closeModal);
  els.fPhone().addEventListener('input', e=> e.target.value = maskPhone(e.target.value));
  els.btnSave().addEventListener('click', async ()=>{
    const payload = {
      // profile
      full_name: els.fName().value.trim(),
      name:      els.fName().value.trim(), // compat
      phone:     els.fPhone().value.trim(),
      email:     (els.fEmail().value || '').trim().toLowerCase() || null,
      last_visit_at: els.fLast().value ? new Date(els.fLast().value).toISOString() : null,
      notes:     els.fNotes().value.trim() || null,
      is_active: els.fActive().value === 'true',
      // auth flags
      create_login: els.fCreateLogin().value === 'true',
      send_invite:  els.fSendInvite().value === 'true'
    };
    if(!payload.full_name){ toast('Informe o nome', false); return; }

    try{
      if(editingId){ await updateClient(editingId, payload); toast('Cliente atualizado'); }
      else{ await createClient(payload); toast('Cliente criado'); }
      closeModal();
      await reload();
    }catch(e){ console.error(e); toast('Erro ao salvar', false); }
  });
}
async function boot(){ bind(); await reload(); }
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
