<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profissionais — Mineiro Barbershop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<main class="app professionals-page" aria-labelledby="title">
  <!-- Topbar -->
  <header class="topbar">
    <a class="back ripple" href="services.html" aria-label="Voltar">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </a>
    <h1 id="title">Profissionais</h1>
  </header>

  <!-- Lista (render via JS) -->
  <section class="list" id="proList" aria-label="Lista de profissionais"></section>

  <!-- Rodapé com resumo e ações -->
  <div class="pro-bar">
    <div class="summary" id="sum">R$ 0,00 • 0 serviço • 0 min</div>
    <button class="btn ripple" id="btnBack" type="button">Voltar</button>
    <button class="btn btn-primary ripple" id="btnNext" type="button" disabled>Continuar</button>
  </div>
</main>

<script>
/* ================== Config ================== */
const N8N_PROS_URLS = [
  'https://primary-jow9-barber.up.railway.app/webhook/professionals',
  'https://primary-jow9-barber.up.railway.app/webhook/profissionals', // fallback se seu fluxo usa esse path
];

/* ================== Utils ================== */
const moneyBR = v => 'R$ ' + Number(v||0).toFixed(2).replace('.', ',');
const getStore = k => localStorage.getItem(k) ?? sessionStorage.getItem(k);

/* ================== Estado vindo de Serviços ================== */
const REQUIRED = new Set(JSON.parse(getStore('svc.selected') || '[]')); // ids dos serviços escolhidos
const total   = Number(getStore('svc.total')   || 0);
const minutes = Number(getStore('svc.minutes') || 0);
const count   = Number(getStore('svc.count')   || 0);
document.getElementById('sum').textContent = `${moneyBR(total)} • ${count} serviço${count>1?'s':''} • ${minutes} min`;

/* ================== Ripple ================== */
(() => {
  document.addEventListener('click', (e) => {
    const el = e.target.closest('.ripple'); if(!el) return;
    const r  = document.createElement('span'); r.className = 'r';
    const b  = el.getBoundingClientRect();
    r.style.left = (e.clientX - b.left) + 'px';
    r.style.top  = (e.clientY - b.top)  + 'px';
    el.appendChild(r);
    r.addEventListener('animationend', () => r.remove(), { once:true });
  }, { passive:true });
})();

/* ================== Reveal ================== */
function applyReveal() {
  const obs = new IntersectionObserver((ents)=>{
    ents.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('is-in'); obs.unobserve(e.target); } });
  }, {threshold:.12, rootMargin:"0px 0px -40px 0px"});
  document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
}

/* ================== Fetch profissionais (n8n) ================== */
async function fetchProfessionals() {
  let lastErr;
  for (const base of N8N_PROS_URLS) {
    try {
      const url = new URL(base);
      url.searchParams.set('limit','500');
      url.searchParams.set('_', String(Date.now()));
      const res = await fetch(url.toString(), { method:'GET' });
      if (!res.ok) { lastErr = new Error(`${res.status}`); continue; }
      const body = await res.json().catch(()=> ({}));

      // normaliza formatos (igual fizemos no services admin)
      let items = [];
      if (Array.isArray(body)) items = body.map(x => x?.json ?? x);
      else if (body?.data && Array.isArray(body.data)) items = body.data;
      else if (body && typeof body === 'object') {
        const vals = Object.values(body);
        if (vals.length && typeof vals[0] === 'object') items = vals.map(v => v?.json ?? v);
      }

      // Só ativos e ordena por nome
      items = (items || []).filter(p => (p.is_active ?? true));
      items.sort((a,b)=> String(a.full_name||a.name||'').localeCompare(String(b.full_name||b.name||'')));

      return items;
    } catch (e) { lastErr = e; }
  }
  throw lastErr || new Error('Falha ao obter profissionais');
}

/* ================== Render lista ================== */
function renderPros(pros) {
  const wrap = document.getElementById('proList');
  if (!pros.length) {
    wrap.innerHTML = `<div class="empty">Nenhum profissional disponível no momento.</div>`;
    return;
  }

  wrap.innerHTML = pros.map(p => {
    const id    = p.id || p.profile_id || p.slug || p.email || crypto.randomUUID();
    const name  = p.full_name || p.name || 'Profissional';
    const rate  = (p.rating_avg != null) ? Number(p.rating_avg).toFixed(1) : null;
    const role  = p.role || 'Barbeiro';
    const bio   = p.bio || p.description || '';
    const phone = p.phone || '';
    const desc  = bio || `${role}${phone ? ' • ' + phone : ''}`;
    const img   = p.avatar_url || p.image_url || '';

    return `
    <article class="item reveal" data-id="${id}">
      <figure class="thumb">${img ? `<img src="${img}" alt="${name}">` : ''}</figure>
      <div class="meta">
        <h3 class="name">${name}${rate ? ` <span class="rate">★ ${rate}</span>` : ''}</h3>
        <p class="desc">${desc}</p>
      </div>
      <button class="choose ripple" type="button" aria-pressed="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        <span>Escolher</span>
      </button>
    </article>`;
  }).join('');

  // fallback de imagem
  document.querySelectorAll('.thumb img').forEach(img=>{
    img.addEventListener('error', ()=>{ const box=img.parentElement; img.remove(); box.classList.add('no-img'); });
  });

  applyReveal();
}

/* ================== Seleção / CTA ================== */
function bindSelection() {
  const btnNext  = document.getElementById('btnNext');
  const btnBack  = document.getElementById('btnBack');
  const items = [...document.querySelectorAll('#proList .item')].map(el => ({
    id: el.dataset.id,
    btn: el.querySelector('.choose'),
    el
  }));
  const selected = new Set();

  function syncUI(){
    items.forEach(c => c.btn.classList.toggle('is-on', selected.has(c.id)));
    btnNext.disabled = selected.size === 0;
    btnNext.textContent = selected.size ? `Continuar (${selected.size})` : 'Continuar';
  }
  syncUI();

  items.forEach(c => {
    c.btn.addEventListener('click', () => {
      selected.has(c.id) ? selected.delete(c.id) : selected.add(c.id);
      syncUI();
    });
  });

  btnNext.addEventListener('click', () => {
    if (selected.size === 0) return;

    // (Opcional) Validação de cobertura de serviços
    // → se no futuro você devolver "skills" do profissional pelo n8n,
    //   dá pra checar se cobrem todos os REQUIRED antes de seguir.

    localStorage.setItem('selectedPros', JSON.stringify([...selected]));
    localStorage.setItem('proMode', 'per'); // multi por serviço
    window.location.href = 'agendamentos.html';
  });

  btnBack.addEventListener('click', () => window.location.href = 'services.html');
}

/* ================== Boot ================== */
(async function boot(){
  try{
    const pros = await fetchProfessionals();
    renderPros(pros);
    bindSelection();
  }catch(err){
    console.error(err);
    document.getElementById('proList').innerHTML =
      `<div class="error" role="alert">Não foi possível carregar os profissionais. Tente novamente.</div>`;
  }
})();
</script>
</body>
</html>
