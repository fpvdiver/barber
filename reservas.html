<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minhas reservas — Mineiro Barbershop</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">

  <style>
    /* ===== específicos desta página ===== */
    .wrap{max-width:428px;margin:0 auto;padding:14px 14px 96px}
    .filters{ padding:0 0 10px; display:flex; gap:10px; overflow:auto; }
    .filters::-webkit-scrollbar{ display:none }
    .chip{
      border:1px solid var(--line); background:#1b1c20; color:#e6e7ea;
      padding:8px 14px; border-radius:999px; font:600 12px/1 Poppins; white-space:nowrap;
      transition:transform .12s ease, background .2s, border-color .2s, color .2s;
    }
    .chip:hover{ transform:translateY(-1px) }
    .chip.is-on{ background:rgba(211,168,91,.18); border-color:rgba(211,168,91,.5); color:var(--gold) }

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
    .empty{padding:28px;text-align:center;color:var(--muted)}

    .item{
      display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;
      padding:12px;border:1px solid var(--line);border-radius:14px;background:#141416;margin-bottom:10px
    }
    .thumb{width:56px;height:56px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#0f0f10}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}

    .meta h3{margin:0 0 2px;font:600 14px/1.2 Poppins}
    .meta p{margin:0;color:#cfd0d4;font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag{font:600 10px/1 Poppins;letter-spacing:.06em;text-transform:uppercase;padding:6px 8px;border-radius:999px;border:1px solid var(--line);color:#e9eaef;background:#111214}

    .status{margin-top:8px;font:600 11px/1 Poppins;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
    .st-upcoming{color:#d2e9ff;background:#0f1822;border-color:#193048}
    .st-completed{color:#c6f7d0;background:#0f1a12;border-color:#1e3a29}
    .st-cancelled{color:#ffd7d7;background:#1a1112;border-color:#3c1a1b}
    .st-rescheduled{color:#ffe9c2;background:#1a150e;border-color:#3a2b12}
    .st-no_show{color:#ffe0b5;background:#1a120b;border-color:#3b2610}

    .actions{display:flex;gap:8px}
    .btnx{
      border:1px solid var(--line);background:#1b1c20;color:#e6e7ea;
      padding:8px 12px;border-radius:10px;font:600 12px/1 Poppins;cursor:pointer
    }
    .btnx.primary{border-color:#7b6335;background:linear-gradient(180deg,var(--gold),var(--gold-2));color:#111}
    .btnx.ghost{background:transparent}
    .btnx.danger{background:#1a1112;border-color:#3c1a1b;color:#ffcccc}
    .btnx:disabled{opacity:.55;cursor:not-allowed}

    /* Detalhes (dialog) */
    dialog::backdrop{background:rgba(0,0,0,.7)}
    dialog{border:0;border-radius:14px;background:#141416;color:var(--text);width:min(420px,92vw)}
    .dlg{padding:16px}
    .dlg h3{margin:0 0 10px;font:600 16px/1 Poppins}
    .dlg p{margin:0 0 8px;color:#d0d2d7}
    .dlg .grid{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin-top:8px}
    .dlg .foot{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}

    .muted{color:var(--muted)}
  </style>
</head>
<body>

<main class="app app--padded reservas-page">

  <!-- Topbar -->
  <header class="topbar">
    <a class="back ripple" href="index.html" aria-label="Voltar">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </a>
    <h1>Minhas reservas</h1>
  </header>

  <div class="wrap">
    <!-- filtros -->
    <nav class="filters" aria-label="Filtrar status">
      <button class="chip ripple is-on" data-filter="all"    type="button">Todas</button>
      <button class="chip ripple"        data-filter="upcoming"    type="button">Próximas</button>
      <button class="chip ripple"        data-filter="completed"   type="button">Concluídas</button>
      <button class="chip ripple"        data-filter="cancelled"   type="button">Canceladas</button>
      <button class="chip ripple"        data-filter="rescheduled" type="button">Remarcadas</button>
      <button class="chip ripple"        data-filter="no_show"     type="button">Não compareceu</button>
    </nav>

    <!-- lista -->
    <section class="panel" aria-live="polite">
      <div id="list"></div>
      <div id="empty" class="empty" hidden>Nenhuma reserva encontrada.</div>
    </section>
  </div>
</main>

<!-- bottom nav -->
<nav class="navbar" role="navigation" aria-label="Principal">
  <a href="index.html" class="active ripple" aria-current="page">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M3 10l9-7 9 7"></path><path d="M9 22V12h6v10"></path>
    </svg>
    Início
  </a>
  <a href="#" class="ripple">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="16" x2="12" y2="12"></line>
      <line x1="12" y1="8" x2="12" y2="8"></line>
    </svg>
    Explorar
  </a>
  <a href="reservas.html" class="ripple">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3" y="4" width="18" height="18" rx="2"></rect>
      <path d="M16 2v4M8 2v4M3 10h18"></path>
    </svg>
    Minhas reservas
  </a>
  <a href="profile.html" class="ripple">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M20 21v-2a4 4 0 0 0-3-3.87"></path>
      <path d="M4 21v-2a4 4 0 0 1 3-3.87"></path>
      <circle cx="12" cy="7" r="4"></circle>
    </svg>
    Perfil
  </a>
</nav>

<!-- dialog detalhes -->
<dialog id="dlg">
  <div class="dlg">
    <h3>Detalhes da reserva</h3>
    <div id="dlgBody"></div>
    <div class="foot">
      <button class="btnx ripple" data-close>Fechar</button>
    </div>
  </div>
</dialog>

<script>
/* ==== utilidades ==== */
const money = v => 'R$ ' + Number(v||0).toFixed(2).replace('.', ',');
const SVC = { corte:'Corte', barba:'Barba', coloracao:'Coloração', tratamento:'Tratamento', sobrancelha:'Sobrancelha' };
const PROS = {
  mineiro:{name:'Mineiro'}, joao:{name:'João Fade'}, maria:{name:'Maria Color'}, pedro:{name:'Pedro Blade'}
};
const THUMBS = { corte:'img/svc-corte.jpg', barba:'img/svc-barba.jpg', coloracao:'img/svc-color.jpg', tratamento:'img/svc-trat.jpg', sobrancelha:'img/svc-sobr.jpg' };

const listEl = document.getElementById('list');
const emptyEl = document.getElementById('empty');
const dlg = document.getElementById('dlg');
const dlgBody = document.getElementById('dlgBody');

/* ==== ripple leve ==== */
document.addEventListener('click',(e)=>{
  const t=e.target.closest('.ripple'); if(!t) return;
  const r=document.createElement('span'); r.className='r';
  const b=t.getBoundingClientRect(); r.style.left=(e.clientX-b.left)+'px'; r.style.top=(e.clientY-b.top)+'px';
  t.appendChild(r); r.addEventListener('animationend',()=>r.remove());
},{passive:true});

/* ==== seeds (se não houver nada salvo) ==== */
function seedIfEmpty(){
  const arr = JSON.parse(localStorage.getItem('bookings') || '[]');
  if(arr.length) return;
  const now = new Date();
  const addDays = (d)=>{ const x=new Date(now); x.setDate(x.getDate()+d); return x; };
  const fmt = (d)=>({
    date: String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear(),
    time: '14:30',
    iso: d.toISOString().slice(0,16)
  });

  const seeds = [
    { id: 'b1', services:['corte','barba'], professionals:['mineiro'], proMode:'any', total:90, minutes:55, count:2, status:'upcoming', ...fmt(addDays(2)) },
    { id: 'b2', services:['coloracao'], professionals:['maria'], proMode:'by_service', total:90, minutes:45, count:1, status:'completed', ...fmt(addDays(-7)) },
    { id: 'b3', services:['tratamento'], professionals:['joao'], proMode:'any', total:70, minutes:35, count:1, status:'cancelled', ...fmt(addDays(-3)) },
    { id: 'b4', services:['corte','coloracao'], professionals:['joao','maria'], proMode:'by_service', total:140, minutes:90, count:2, status:'rescheduled', ...fmt(addDays(-1)) },
    { id: 'b5', services:['sobrancelha'], professionals:['pedro'], proMode:'any', total:30, minutes:15, count:1, status:'no_show', ...fmt(addDays(-10)) },
  ];
  localStorage.setItem('bookings', JSON.stringify(seeds));
}
seedIfEmpty();

/* ==== carregar ==== */
function loadBookings(){ return JSON.parse(localStorage.getItem('bookings') || '[]'); }
function saveBookings(arr){ localStorage.setItem('bookings', JSON.stringify(arr)); }

/* ==== render ==== */
const statusClass = s => ({
  upcoming:'st-upcoming', completed:'st-completed', cancelled:'st-cancelled', rescheduled:'st-rescheduled', no_show:'st-no_show'
}[s] || 'st-upcoming');

const statusLabel = s => ({
  upcoming:'Agendado', completed:'Concluído', cancelled:'Cancelado', rescheduled:'Remarcado', no_show:'Não compareceu'
}[s] || s);

function render(filter='all'){
  const data = loadBookings();
  const list = data
    .filter(b => filter==='all' ? true : b.status===filter)
    .sort((a,b)=> (b.iso||'').localeCompare(a.iso||''));

  listEl.innerHTML = '';
  emptyEl.hidden = list.length>0;

  list.forEach(b=>{
    const firstSvc = b.services?.[0] || 'corte';
    const img = THUMBS[firstSvc] || 'img/reco1.jpg';
    const prosNames = (b.professionals||[]).map(id => PROS[id]?.name || 'Profissional').join(', ');

    const el = document.createElement('article');
    el.className = 'item reveal';
    el.innerHTML = `
      <figure class="thumb"><img src="${img}" alt=""></figure>
      <div class="meta">
        <h3>${b.services.map(s=>SVC[s]||s).join(' + ')}</h3>
        <p>${b.date} • ${b.time} • ${prosNames || 'Qualquer profissional'}</p>
        <div class="row">
          <span class="tag">${b.proMode==='by_service'?'Por serviço':'Qualquer profissional'}</span>
          <span class="tag">${b.minutes||0} min</span>
          <span class="tag">${money(b.total||0)}</span>
        </div>
        <span class="status ${statusClass(b.status)}">${statusLabel(b.status)}</span>
      </div>
      <div class="actions">
        <button class="btnx primary ripple" data-act="rebook" data-id="${b.id}">Remarcar</button>
        <button class="btnx danger ripple" data-act="cancel" data-id="${b.id}" ${b.status!=='upcoming'?'disabled':''}>Cancelar</button>
      </div>
    `;
    listEl.appendChild(el);
  });

  // reveal simples
  const io = new IntersectionObserver(ents=>{
    ents.forEach(en=>{ if(en.isIntersecting){ en.target.classList.add('is-in'); io.unobserve(en.target); }});
  },{threshold:.12});
  document.querySelectorAll('.reveal').forEach(x=>io.observe(x));
}
render();

/* ==== filtros ==== */
document.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('is-on', c===ch));
    render(ch.dataset.filter);
  });
});

/* ==== ações ==== */
listEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]'); if(!btn) return;
  const id = btn.dataset.id;
  const act = btn.dataset.act;
  const arr = loadBookings();
  const ix = arr.findIndex(x=>x.id===id);
  if(ix<0) return;

  const b = arr[ix];

  if(act==='details'){
    // abre dialog com detalhes
    dlgBody.innerHTML = `
      <div class="grid">
        <span class="muted">Status:</span><strong>${statusLabel(b.status)}</strong>
        <span class="muted">Data:</span><strong>${b.date}</strong>
        <span class="muted">Hora:</span><strong>${b.time}</strong>
        <span class="muted">Serviços:</span><strong>${b.services.map(s=>SVC[s]||s).join(', ')}</strong>
        <span class="muted">Profissional(is):</span><strong>${(b.professionals||[]).map(p=>PROS[p]?.name||p).join(', ') || 'Qualquer'}</strong>
        <span class="muted">Duração:</span><strong>${b.minutes||0} min</strong>
        <span class="muted">Total:</span><strong>${money(b.total||0)}</strong>
        ${b.deposit ? `<span class="muted">Pré-agendamento (30%):</span><strong>${money(b.deposit)}</strong>` : ''}
      </div>
    `;
    dlg.showModal();
    return;
  }

  if(act==='rebook'){
    // guarda intenção e manda para agendamento com os mesmos serviços
    sessionStorage.setItem('rebookFrom', JSON.stringify({
      services: b.services,
      professionals: b.professionals,
      proMode: b.proMode
    }));
    // também já persistimos seleção mínima usada no fluxo atual
    sessionStorage.setItem('svc.selected', JSON.stringify(b.services || []));
    sessionStorage.setItem('selectedPros', JSON.stringify(b.professionals || []));
    sessionStorage.setItem('proMode', b.proMode || 'any');
    window.location.href = 'agendamentos.html';
    return;
  }

  if(act==='cancel'){
    if(!confirm('Deseja cancelar esta reserva?')) return;
    b.status = 'cancelled';
    arr[ix] = b;
    saveBookings(arr);
    render(document.querySelector('.chip.is-on')?.dataset.filter || 'all');
    return;
  }
});

/* fechar dialog */
document.querySelector('[data-close]').addEventListener('click', ()=> dlg.close());

/* ==== integração com confirmacao.html (opcional)
   Se a página de confirmação gravar a nova reserva em localStorage.newBooking,
   aqui a gente captura, joga para bookings e limpa. ==== */
(function consumeNewBooking(){
  const raw = localStorage.getItem('newBooking');
  if(!raw) return;
  try {
    const n = JSON.parse(raw);
    const arr = loadBookings();
    if(!n.id){ n.id = 'b' + Date.now(); }
    if(!n.status){ n.status = 'upcoming'; }
    arr.push(n);
    saveBookings(arr);
    localStorage.removeItem('newBooking');
    // re-render para aparecer imediatamente
    render(document.querySelector('.chip.is-on')?.dataset.filter || 'all');
  } catch(_) { /* noop */ }
})();
</script>
</body>
</html>
