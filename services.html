<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Serviços — Mineiro Barbershop</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<main class="app" aria-labelledby="page-title">
  <!-- Topbar -->
  <header class="topbar">
    <a class="back ripple" href="index.html" aria-label="Voltar">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </a>
    <h1 id="page-title">Serviços</h1>
  </header>

  <!-- Filtros (preenchidos via JS) -->
  <nav class="filters" aria-label="Filtrar categorias" id="filters"></nav>

  <!-- Lista (render via JS) -->
  <section class="list" aria-label="Lista de serviços" id="svc-list"></section>

  <!-- CTA inferior -->
  <div class="cta-bar">
    <button class="btn" data-del disabled>Deletar</button>
    <button class="btn btn-primary" data-next disabled>Avançar</button>
  </div>

  <p class="hide-text" aria-live="polite" id="sr-status"></p>
</main>

<script>
/* ================== Config ================== */
const N8N_BASE_URL = 'https://primary-jow9-barber.up.railway.app/webhook/services';

/* ================== Utils ================== */
const money = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const moneyBR = v => 'R$ ' + v.toFixed(2).replace('.', ',');
const slug = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

/* ================== Ripple ================== */
(() => {
  const add = (e)=>{
    const el = e.currentTarget, r=document.createElement('span');
    r.className='r'; const b=el.getBoundingClientRect();
    r.style.left=(e.clientX-b.left)+'px'; r.style.top=(e.clientY-b.top)+'px';
    el.appendChild(r); r.addEventListener('animationend',()=>r.remove());
  };
  document.addEventListener('click',(e)=>{const btn=e.target.closest('.ripple'); if(btn) add(e);},{passive:true});
})();

/* ================== Reveal on scroll ================== */
function applyReveal() {
  const obs = new IntersectionObserver((ents)=>{
    ents.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('is-in'); obs.unobserve(e.target); } });
  }, {threshold:.12, rootMargin:"0px 0px -40px 0px"});
  document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
}

/* ================== Fetch serviços (n8n) ================== */
async function fetchServices() {
  const url = new URL(N8N_BASE_URL);
  url.searchParams.set('limit', '500');
  url.searchParams.set('_', String(Date.now()));
  const res = await fetch(url.toString(), { method: 'GET' });
  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    throw new Error(`Falha ao listar serviços (${res.status}): ${t||'-'}`);
  }
  const body = await res.json().catch(()=> null);

  // normaliza retorno (igual fizemos no admin)
  let items = [];
  if (Array.isArray(body)) items = body.map(x => x?.json ?? x);
  else if (body?.data && Array.isArray(body.data)) items = body.data;
  else if (body && typeof body === 'object') {
    const vals = Object.values(body);
    if (vals.length && typeof vals[0] === 'object') items = vals.map(v => v?.json ?? v);
  }
  // filtra ativos e com preço/duração válidos
  items = items.filter(s => (s.is_active ?? s.active ?? true) && (s.price_cents != null) && (s.duration_min != null));
  // ordena por categoria, depois nome
  items.sort((a,b)=> String(a.category||'').localeCompare(String(b.category||'')) || String(a.name||'').localeCompare(String(b.name||'')));
  return items;
}

/* ================== Render filtros ================== */
function renderFilters(services) {
  const wrap = document.getElementById('filters');
  const cats = Array.from(new Set(services.map(s => (s.category || 'Outros').trim())));

  const chips = [
    { key: 'all', label: 'Todos', on: true },
    ...cats.map(c => ({ key: slug(c)||'outros', label: c, on: false }))
  ];

  wrap.innerHTML = chips.map(ch => `
    <button class="chip ripple ${ch.on?'is-on':''}" type="button" data-filter="${ch.key}">${ch.label}</button>
  `).join('');

  // bind
  const items = document.querySelectorAll('.list .item');
  function apply(val){
    wrap.querySelectorAll('.chip').forEach(c=>c.classList.toggle('is-on', c.dataset.filter===val));
    document.querySelectorAll('.list .item').forEach(it=>{
      const tag = it.dataset.tag || 'outros';
      const show = (val==='all') || (tag === val);
      it.toggleAttribute('hidden', !show);
    });
  }
  wrap.querySelectorAll('.chip').forEach(chip => chip.addEventListener('click', ()=> apply(chip.dataset.filter)));
}

/* ================== Render lista ================== */
function renderList(services) {
  const list = document.getElementById('svc-list');
  if (!services.length) {
    list.innerHTML = `<div class="empty">Nenhum serviço disponível no momento.</div>`;
    return;
  }

  list.innerHTML = services.map(s => {
    const catSlug = slug(s.category || 'Outros') || 'outros';
    const imgSrc  = s.image_url || '';
    const desc    = s.description ? String(s.description) : `Duração aproximada — ${s.duration_min}min`;
    return `
    <article class="item reveal" data-id="${s.id}" data-price="${s.price_cents/100}" data-min="${s.duration_min}" data-tag="${catSlug}">
      <figure class="thumb">${imgSrc ? `<img src="${imgSrc}" alt="${s.name}">` : ''}</figure>
      <div class="meta">
        <h3 class="name">${s.name || 'Serviço'}</h3>
        <span class="price-badge" data-p>${money(s.price_cents/100)}</span>
        <p class="desc">${desc}</p>
      </div>
      <button class="choose ripple" type="button" aria-pressed="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
             stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        <span>Escolher</span>
      </button>
    </article>`;
  }).join('');

  // fallback de imagem
  document.querySelectorAll('.thumb img').forEach(img=>{
    img.addEventListener('error', ()=>{ const box=img.parentElement; img.remove(); box.classList.add('no-img'); });
  });

  applyReveal();
}

/* ================== Seleção / Footer ================== */
function bindSelection() {
  const btnDel  = document.querySelector('[data-del]');
  const btnNext = document.querySelector('[data-next]');
  const cards = [...document.querySelectorAll('.list .item')].map(el => ({
    id: el.dataset.id,
    price: Number(el.dataset.price || 0),
    min: Number(el.dataset.min || 0),
    el,
    btn: el.querySelector('.choose')
  }));

  const stack = []; // [{id, price, min}]

  function updateFooter(){
    const count = stack.length;
    const total = stack.reduce((a,s)=>a+s.price,0);
    btnDel.disabled  = count === 0;
    btnNext.disabled = count === 0;
    btnNext.textContent = count ? `Avançar (${count}) — ${moneyBR(total)}` : 'Avançar';
  }
  updateFooter();

  cards.forEach(({ id, price, min, btn }) => {
    btn.addEventListener('click', () => {
      const on = btn.classList.toggle('is-on');
      const ix = stack.findIndex(s => s.id === id);
      if (on && ix === -1) stack.push({ id, price, min });
      if (!on && ix !== -1) stack.splice(ix, 1);
      updateFooter();
    });
  });

  btnDel.addEventListener('click', () => {
    if (!stack.length) return;
    const last = stack.pop();
    const card = cards.find(c => c.id === last.id);
    if (card) card.btn.classList.remove('is-on');
    updateFooter();
  });

  btnNext.addEventListener('click', () => {
    const ids     = stack.map(s => s.id);
    const total   = stack.reduce((a,s)=>a+s.price, 0);
    const minutes = stack.reduce((a,s)=>a+s.min,   0);

    localStorage.setItem('svc.selected', JSON.stringify(ids));
    localStorage.setItem('svc.total', String(total));
    localStorage.setItem('svc.minutes', String(minutes));
    localStorage.setItem('svc.count', String(ids.length));

    window.location.href = 'professionals.html';
  });
}

/* ================== Boot ================== */
(async function boot(){
  try{
    const services = await fetchServices();
    renderList(services);
    renderFilters(services);
    bindSelection();
  }catch(err){
    console.error(err);
    document.getElementById('svc-list').innerHTML =
      `<div class="error" role="alert">Não foi possível carregar os serviços. Tente novamente em instantes.</div>`;
  }
})();
</script>
</body>
</html>
